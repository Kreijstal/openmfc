name: Phase 1 - Layout & EH Harvest

on:
  workflow_dispatch:

jobs:
  harvest-windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v6
      - name: Setup MSVC
        uses: ilammy/msvc-dev-cmd@v1

      - name: Build harvester
        shell: cmd
        run: |
          mkdir artifacts
          cl /nologo /EHsc /MD /Zi ^
            /I"%VCToolsInstallDir%ATLMFC\include" /I"%VCToolsInstallDir%include" ^
            phase1\harvest\harvest.cpp ^
            /Fe:artifacts\harvest.exe ^
            /link /LIBPATH:"%VCToolsInstallDir%ATLMFC\lib\x64" mfc140u.lib

      - name: Run harvester
        shell: pwsh
        run: |
          Set-Location artifacts
          .\harvest.exe

      - name: Build tracer (Windows)
        shell: pwsh
        run: |
          cl /nologo /LD tools\tracer\windows\tracer_detours.cpp /Fe:artifacts\tracer_detours.dll

      - name: Test tracer
        shell: pwsh
        run: |
          $env:TRACE_OUT = "artifacts\golden_trace.json"
          $dll = "$(Resolve-Path artifacts\tracer_detours.dll)"
          rundll32 $dll,tracer_init
          [void][System.Reflection.Assembly]::LoadWithPartialName('System.Windows.Forms')
          [System.Runtime.InteropServices.Marshal]::GetHINSTANCE([System.Reflection.Assembly]::GetExecutingAssembly().ManifestModule) | Out-Null
          Get-Content artifacts\golden_trace.json -ErrorAction SilentlyContinue

      - name: Upload artifacts
        uses: actions/upload-artifact@v5
        with:
          name: phase1_harvest
          path: artifacts/
          retention-days: 14

  build-wine-tracer:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - name: Install mingw
        run: sudo apt-get update && sudo apt-get install -y mingw-w64
      - name: Build wine tracer
        run: |
          mkdir -p artifacts
          x86_64-w64-mingw32-gcc -shared -O2 tools/tracer/wine/tracer_wine.c -o artifacts/tracer_wine.dll
      - name: Upload wine tracer
        uses: actions/upload-artifact@v5
        with:
          name: phase1_wine_tracer
          path: artifacts/tracer_wine.dll
          retention-days: 14

  import-libs:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v6
      - name: Setup MSVC
        uses: ilammy/msvc-dev-cmd@v1
      - name: Generate DEF and import libs for CRT
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path artifacts | Out-Null
          $ucrt = "$env:SystemRoot\System32\ucrtbase.dll"
          $vcrt = "$env:SystemRoot\System32\vcruntime140.dll"
          foreach ($pair in @(@{Name='ucrtbase'; Path=$ucrt}, @{Name='vcruntime140'; Path=$vcrt})) {
            $def = "artifacts/$($pair.Name).def"
            $exp = & dumpbin /nologo /exports $pair.Path
            $names = @("LIBRARY $($pair.Name)", "EXPORTS")
            foreach ($line in $exp) {
              if ($line -match '^\s*\d+\s+[0-9A-Fa-f]+\s+[0-9A-Fa-f]+\s+(\S+)$') { $names += $Matches[1] }
            }
            $names | Set-Content -Path $def -Encoding ASCII
            lib /def:$def /machine:x64 /out:"artifacts/$($pair.Name).lib"
          }
      - name: Upload CRT import libs
        uses: actions/upload-artifact@v5
        with:
          name: phase1_crt_imports
          path: artifacts/
          retention-days: 14
