name: Phase 4 - CString Tests

on:
  push:
    branches: [phase4-cstring, phase4-cobject, phase4-cwnd, master]
  pull_request:
    branches: [master]
  workflow_dispatch:

jobs:
  test-cstring:
    runs-on: windows-latest
    
    steps:
    - uses: actions/checkout@v6
    
    - name: Setup MSVC
      uses: ilammy/msvc-dev-cmd@v1
      with:
        arch: x64

    - name: Build and run CString tests
      shell: cmd
      run: |
        cl.exe /nologo /EHsc /std:c++17 /I include /Fe:test_cstring.exe tests\test_cstring.cpp
        if %ERRORLEVEL% neq 0 exit /b %ERRORLEVEL%
        test_cstring.exe
        if %ERRORLEVEL% neq 0 exit /b %ERRORLEVEL%
        echo MSVC CString tests passed!

    - name: Build and run CObject tests
      shell: cmd
      run: |
        cl.exe /nologo /EHsc /std:c++17 /I include /Fe:test_cobject.exe tests\test_cobject.cpp
        if %ERRORLEVEL% neq 0 exit /b %ERRORLEVEL%
        test_cobject.exe
        if %ERRORLEVEL% neq 0 exit /b %ERRORLEVEL%
        echo MSVC CObject tests passed!

    - name: Build and run CArray tests
      shell: cmd
      run: |
        cl.exe /nologo /EHsc /std:c++17 /I include /Fe:test_carray_removeat.exe tests\test_carray_removeat.cpp
        if %ERRORLEVEL% neq 0 exit /b %ERRORLEVEL%
        test_carray_removeat.exe
        if %ERRORLEVEL% neq 0 exit /b %ERRORLEVEL%
        echo MSVC CArray tests passed!

    - name: Build and run OLE Dispatch tests
      shell: cmd
      run: |
        cl.exe /nologo /EHsc /std:c++17 /I include /Fe:test_ole_dispatch.exe tests\test_ole_dispatch.cpp oleaut32.lib
        if %ERRORLEVEL% neq 0 exit /b %ERRORLEVEL%
        test_ole_dispatch.exe
        if %ERRORLEVEL% neq 0 exit /b %ERRORLEVEL%
        echo MSVC OLE Dispatch tests passed!

    - name: Build and run OLE Dispatch exception tests
      shell: cmd
      run: |
        cl.exe /nologo /EHsc /std:c++17 /I include /Fe:test_ole_dispatch_exception.exe tests\test_ole_dispatch_exception.cpp oleaut32.lib
        if %ERRORLEVEL% neq 0 exit /b %ERRORLEVEL%
        test_ole_dispatch_exception.exe
        if %ERRORLEVEL% neq 0 exit /b %ERRORLEVEL%
        echo MSVC OLE Dispatch exception tests passed!

    - name: Build and run OLE Dispatch integration tests
      shell: cmd
      run: |
        cl.exe /nologo /EHsc /std:c++17 /I include /Fe:test_ole_dispatch_integration.exe tests\test_ole_dispatch_integration.cpp ole32.lib oleaut32.lib
        if %ERRORLEVEL% neq 0 exit /b %ERRORLEVEL%
        test_ole_dispatch_integration.exe
        if %ERRORLEVEL% neq 0 exit /b %ERRORLEVEL%
        echo MSVC OLE Dispatch integration tests passed!

    - name: Build and run CWnd tests
      shell: cmd
      run: |
        cl.exe /nologo /EHsc /std:c++17 /I include /DOPENMFC_APPCORE_IMPL /Fe:test_cwnd.exe tests\test_cwnd.cpp src\mfc\appcore.cpp src\mfc\exceptions.cpp src\mfc\afxmem.cpp user32.lib
        if %ERRORLEVEL% neq 0 exit /b %ERRORLEVEL%
        test_cwnd.exe
        if %ERRORLEVEL% neq 0 exit /b %ERRORLEVEL%
        echo MSVC CWnd tests passed!

    - name: Build and run Core App tests
      shell: cmd
      run: |
        cl.exe /nologo /EHsc /std:c++17 /I include /DOPENMFC_APPCORE_IMPL /Fe:test_core_app.exe tests\test_core_app.cpp src\mfc\appcore.cpp src\mfc\exceptions.cpp src\mfc\afxmem.cpp user32.lib
        if %ERRORLEVEL% neq 0 exit /b %ERRORLEVEL%
        test_core_app.exe
        if %ERRORLEVEL% neq 0 exit /b %ERRORLEVEL%
        echo MSVC Core App tests passed!

  test-mingw-cross:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v6
    
    - name: Install MinGW
      run: sudo apt-get update && sudo apt-get install -y mingw-w64
      
    - name: Build with MinGW
      run: |
        x86_64-w64-mingw32-g++ -std=c++17 -DUNICODE -D_UNICODE -DOPENMFC_APPCORE_IMPL -I include -o test_string_funcs.exe tests/test_string_funcs.cpp src/mfc/strcore.cpp src/mfc/appcore.cpp src/mfc/exceptions.cpp src/mfc/afxmem.cpp
        echo "MinGW Build successful"
