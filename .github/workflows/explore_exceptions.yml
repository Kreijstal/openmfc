name: Explore MSVC Exceptions

on:
  workflow_dispatch:
  push:
    paths:
      - 'phase4/tests/test_cxx_throw_exploration.cpp'
      - 'phase4/tests/test_exception_catch.cpp'
      - 'phase4/src/mfc_exceptions.cpp'

jobs:
  # Job 1: Build DLL with MinGW on Linux
  build-dll:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install MinGW
        run: sudo apt-get update && sudo apt-get install -y mingw-w64

      - name: Build Phase 4 DLL
        run: ./phase4/scripts/build_phase4.sh

      - name: Upload DLL
        uses: actions/upload-artifact@v4
        with:
          name: openmfc-dll
          path: |
            build-phase4/openmfc.dll
            build-phase4/openmfc.def
          retention-days: 7

  # Job 2: Build and run tests on Windows
  test-exceptions:
    needs: build-dll
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download DLL
        uses: actions/download-artifact@v4
        with:
          name: openmfc-dll
          path: .

      - name: Setup MSVC
        uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: x64

      - name: Create import library
        shell: cmd
        run: |
          lib /DEF:openmfc.def /OUT:openmfc.lib /MACHINE:X64

      - name: Build exception catch test
        shell: cmd
        run: |
          cl /nologo /EHsc /MD phase4\tests\test_exception_catch.cpp openmfc.lib /Fe:test_exception_catch.exe
          if %ERRORLEVEL% neq 0 exit /b 1
          echo Build successful

      - name: Run exception catch test
        shell: pwsh
        run: |
          Write-Host "=== Running Exception Catch Test ===" -ForegroundColor Cyan
          $output = & .\test_exception_catch.exe 2>&1 | Out-String
          Write-Host $output

          if ($output -match "SUCCESS: Caught CMemoryException") {
            Write-Host "FULL SUCCESS: Exception caught with correct type!" -ForegroundColor Green
            exit 0
          } elseif ($output -match "SUCCESS|PARTIAL") {
            Write-Host "PARTIAL SUCCESS: Exception was thrown and caught" -ForegroundColor Yellow
            exit 0
          } else {
            Write-Host "FAILED: Exception was not caught" -ForegroundColor Red
            exit 1
          }

      - name: Build exploration test
        shell: cmd
        run: |
          cl /nologo /EHsc /MD /FA phase4\tests\test_cxx_throw_exploration.cpp /Fe:test_cxx_throw_exploration.exe

      - name: Run exploration test
        shell: pwsh
        run: |
          Write-Host "=== Running Exception Exploration Test ===" -ForegroundColor Cyan
          $output = & .\test_cxx_throw_exploration.exe 2>&1 | Out-String
          Write-Host $output

      - name: Upload test artifacts
        uses: actions/upload-artifact@v4
        with:
          name: exception-tests
          path: |
            *.exe
            *.asm
          retention-days: 7
