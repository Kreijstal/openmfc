name: Phase 1 - Extract Symbols

on:
  workflow_dispatch:

jobs:
  extract:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v6

      - name: Setup MSVC
        uses: ilammy/msvc-dev-cmd@v1

      - name: Ensure VC Redist (for mfc/atl DLLs)
        shell: pwsh
        run: choco install vcredist140 -y

      - name: Locate reference DLLs
        id: locate
        shell: pwsh
        run: |
          $vswhereExe = Join-Path ${env:ProgramFiles(x86)} "Microsoft Visual Studio\Installer\vswhere.exe"
          function Find-Dll([string]$name) {
            if (Test-Path $vswhereExe) {
              $vsHits = & $vswhereExe -products * -find "**\$name" 2>$null
              foreach ($h in $vsHits) { if (Test-Path $h) { return Get-Item $h } }
            }
            foreach ($p in @("C:\Windows\System32\$name", "C:\Windows\SysWOW64\$name")) {
              if (Test-Path $p) { return Get-Item $p }
            }
            $roots = @(
              $env:VCToolsRedistDir,
              $env:VCToolsInstallDir,
              $env:VSINSTALLDIR,
              'C:\Program Files\Microsoft Visual Studio',
              'C:\Program Files (x86)\Microsoft Visual Studio'
            ) | Where-Object { $_ -and (Test-Path $_) }
            foreach ($root in $roots) {
              Write-Host "Searching $root for $name"
              $hit = Get-ChildItem -Path $root -Filter $name -Recurse -ErrorAction SilentlyContinue -File | Select-Object -First 1
              if ($hit) { return $hit }
            }
            return $null
          }

          if (Test-Path $vswhereExe) {
            $redist = & $vswhereExe -products * -find "VC\Redist\MSVC\*\vc_redist.x64.exe" 2>$null | Select-Object -First 1
            if ($redist) {
              Write-Host "Installing VC redist from $redist"
              Start-Process -FilePath $redist -ArgumentList '/install','/quiet','/norestart' -Wait
            }
          }

          $mfc = Find-Dll -name 'mfc140u.dll'
          $atl = Find-Dll -name 'atl140.dll'
          if (-not $mfc) { Write-Error "mfc140u.dll not found"; exit 1 }
          if (-not $atl) { Write-Warning "atl140.dll not found; skipping ATL export harvest" }
          "mfc=$($mfc.FullName)" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
          if ($atl) { "atl=$($atl.FullName)" | Out-File -FilePath $env:GITHUB_OUTPUT -Append } else { "atl=" | Out-File -FilePath $env:GITHUB_OUTPUT -Append }

      - name: Dump exports
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path artifacts | Out-Null
          foreach ($pair in @(@{Name='mfc'; Path='${{ steps.locate.outputs.mfc }}'}, @{Name='atl'; Path='${{ steps.locate.outputs.atl }}'})) {
            if (-not $pair.Path) { Write-Host "Skipping $($pair.Name); no path"; continue }
            $out = "artifacts/$($pair.Name).exports"
            & dumpbin /nologo /exports $pair.Path | Out-File -FilePath $out -Encoding ASCII
          }

      - name: Demangle names
        shell: pwsh
        run: |
          $out = "artifacts/demangled.txt"
          Remove-Item -ErrorAction SilentlyContinue $out
          Get-ChildItem artifacts -Filter "*.exports" | ForEach-Object {
            Get-Content $_ | ForEach-Object {
              if ($_ -match '^\s*\d+\s+[0-9A-Fa-f]+\s+[0-9A-Fa-f]+\s+(?<name>\S+)$') {
                $name = $Matches['name']
                $pretty = (& undname.exe $name) -join ' '
                "$name => $pretty" | Out-File -FilePath $out -Append -Encoding ASCII
              }
            }
          }

      - name: Metadata and hash
        shell: pwsh
        run: |
          $meta = @{}
          $meta.mfc_version = (Get-Item '${{ steps.locate.outputs.mfc }}').VersionInfo.ProductVersion
          $meta.vs_version = $env:VisualStudioVersion
          $meta.sha256_mfc140u = (Get-FileHash '${{ steps.locate.outputs.mfc }}' -Algorithm SHA256).Hash.ToLower()
          if ('${{ steps.locate.outputs.atl }}') {
            $meta.sha256_atl140 = (Get-FileHash '${{ steps.locate.outputs.atl }}' -Algorithm SHA256).Hash.ToLower()
          } else {
            $meta.sha256_atl140 = ''
          }
          $json = ($meta | ConvertTo-Json -Depth 4)
          $json | Out-File -FilePath artifacts/metadata.json -Encoding ASCII

      - name: Generate mfc_db.json
        shell: bash
        run: |
          args=(--dll mfc140u --exports artifacts/mfc.exports)
          if [ -s artifacts/atl.exports ]; then
            args+=(--dll atl140 --exports artifacts/atl.exports)
          fi
          python tools/parse_exports.py \
            "${args[@]}" \
            --demangled artifacts/demangled.txt \
            --metadata artifacts/metadata.json \
            --out artifacts/mfc_db.json

      - name: Upload artifacts
        uses: actions/upload-artifact@v5
        with:
          name: phase1_exports
          path: artifacts/
          retention-days: 14
