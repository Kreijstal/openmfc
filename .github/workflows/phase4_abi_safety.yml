name: Phase 4 - ABI Safety Checks

on:
  push:
    branches: [phase4-*, master]
  pull_request:
    branches: [master]
  workflow_dispatch:

jobs:
  abi-safety-checks:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v6
    
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y mingw-w64 python3-pip
        pip3 install -r requirements.txt 2>/dev/null || echo "No requirements.txt found"
    
    - name: Build Phase 4
      run: |
        ./phase4/scripts/build_phase4.sh
    
    - name: Run ABI safety checks
      run: |
        echo "=== Running ABI Safety Checks ==="
        echo ""
        
        # 1. Exact ABI verification
        echo "1. Exact ABI verification..."
        python3 scripts/verify_exact_abi.py \
          --mapping mfc_complete_ordinal_mapping.json \
          --dll build-phase4/openmfc.dll
        
        # 2. MSVC mangling detection
        echo ""
        echo "2. MSVC mangling detection..."
        ./scripts/test_msvc_abi_simple.sh build-phase4/openmfc.dll
        
        # 3. Implementation safety validation
        echo ""
        echo "3. Implementation safety validation..."
        python3 scripts/validate_implementation_safety.py \
          "phase4/src/*.cpp"
        
        # 4. ABI regression detection
        echo ""
        echo "4. ABI regression detection..."
        ./scripts/check_abi_regression.sh
        
        # 5. Drop-in replacement test
        echo ""
        echo "5. Drop-in replacement test..."
        ./scripts/test_dropin_replacement.sh
        
        echo ""
        echo "✅ All ABI safety checks passed!"
    
    - name: Upload safety report
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: abi-safety-report
        path: |
          build-phase4/openmfc.dll
          build-phase4/openmfc.def
        retention-days: 7
  
  msvc-linking-test:
    runs-on: windows-latest
    needs: abi-safety-checks
    
    steps:
    - uses: actions/checkout@v6
    
    - name: Download Phase 4 artifacts
      uses: actions/download-artifact@v7
      with:
        name: abi-safety-report
        path: phase4-artifacts
    
    - name: Setup MSVC
      uses: ilammy/msvc-dev-cmd@v1
      with:
        arch: x64
    
    - name: Create MSVC import library
      shell: cmd
      run: |
        echo Creating MSVC import library from .def file...
        lib /DEF:phase4-artifacts\openmfc.def /OUT:openmfc.lib /MACHINE:X64
        if %ERRORLEVEL% neq 0 (
          echo Failed to create MSVC import library
          exit /b 1
        )
        echo Successfully created openmfc.lib
    
    - name: Build MSVC test app
      shell: cmd
      run: |
        echo Building MSVC test application...
        cl.exe /nologo /EHsc /std:c++17 /I include /D_AFXDLL /DOPENMFC_APPCORE_IMPL /Fe:test_msvc_linking.exe tests\test_msvc_app.cpp openmfc.lib
        if %ERRORLEVEL% neq 0 (
          echo Failed to build MSVC test app
          exit /b 1
        )
        echo Successfully built test_msvc_linking.exe
    
    - name: Run MSVC linking test
      shell: pwsh
      run: |
        echo "Running MSVC linking test..."
        Copy-Item phase4-artifacts\openmfc.dll .
        
        $output = & .\test_msvc_linking.exe 2>&1 | Out-String
        Write-Host $output
        
        if ($LASTEXITCODE -eq 0) {
          Write-Host "✅ MSVC linking test passed!"
        } else {
          Write-Host "❌ MSVC linking test failed"
          exit 1
        }
    
    - name: Run comprehensive ABI test
      shell: pwsh
      run: |
        echo "Running comprehensive ABI test..."
        
        # Build the comprehensive test
        cl.exe /nologo /EHsc /std:c++17 /I include /D_AFXDLL /DOPENMFC_APPCORE_IMPL /Fe:test_comprehensive.exe test_comprehensive.cpp openmfc.lib
        
        if ($LASTEXITCODE -ne 0) {
          Write-Host "Failed to build comprehensive test"
          exit 1
        }
        
        # Run the test
        $output = & .\test_comprehensive.exe 2>&1 | Out-String
        Write-Host $output
        
        if ($LASTEXITCODE -eq 0) {
          Write-Host "✅ Comprehensive ABI test passed!"
        } else {
          Write-Host "❌ Comprehensive ABI test failed"
          exit 1
        }
  
  wine-runtime-test:
    runs-on: ubuntu-latest
    needs: abi-safety-checks
    
    steps:
    - uses: actions/checkout@v6
    
    - name: Download Phase 4 artifacts
      uses: actions/download-artifact@v7
      with:
        name: abi-safety-report
        path: build-phase4
    
    - name: Install Wine
      run: |
        sudo apt-get update
        sudo apt-get install -y wine64
        
    - name: Run Wine runtime test
      run: |
        chmod +x scripts/test_wine_runtime.sh
        ./scripts/test_wine_runtime.sh
    
    - name: Run MFC functionality tests
      run: |
        chmod +x tests/run_functionality_tests.sh
        ./tests/run_functionality_tests.sh
