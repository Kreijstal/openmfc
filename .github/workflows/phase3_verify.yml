name: Phase 3 - Hollow Build & Link

on:
  workflow_dispatch:
  push:
    branches: [phase3-hollow-build]

jobs:
  build-mingw-dll:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      
      - name: Install mingw
        run: sudo apt-get update && sudo apt-get install -y mingw-w64
      
      - name: Download latest Phase1 artifacts
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          mkdir -p artifacts
          # Get latest successful phase1 run
          harvest_run=$(gh run list --workflow phase1_harvest.yml --limit 1 --json databaseId,status --jq '.[] | select(.status=="completed") | .databaseId' | head -1)
          if [ -z "$harvest_run" ]; then
            echo "ERROR: No completed phase1_harvest runs found"
            exit 1
          fi
          
          # Get latest successful extract_symbols run  
          exports_run=$(gh run list --workflow extract_symbols.yml --limit 1 --json databaseId,status --jq '.[] | select(.status=="completed") | .databaseId' | head -1)
          if [ -z "$exports_run" ]; then
            echo "ERROR: No completed extract_symbols runs found"
            exit 1
          fi
          
          crt_run=$harvest_run
          echo "Using phase1_harvest run ${harvest_run}"
          gh run download "$harvest_run" --name phase1_harvest --dir artifacts/harvest
          echo "Using phase1_crt_imports run ${crt_run}"
          gh run download "$crt_run" --name phase1_crt_imports --dir artifacts/crt || true
          echo "Using extract_symbols run ${exports_run}"
          gh run download "$exports_run" --name phase1_exports --dir artifacts/exports
          # flatten key inputs
          find artifacts -name mfc_db.json -o -name exceptions.json -o -name layouts.json -o -name 'ucrtbase.def' -o -name 'vcruntime140.def' -o -name 'mfc.exports' -o -name 'metadata.json' -o -name 'demangled.txt'
          find artifacts -name mfc_db.json -o -name exceptions.json -o -name layouts.json -o -name 'ucrtbase.def' -o -name 'vcruntime140.def' -o -name 'mfc.exports' -o -name 'metadata.json' -o -name 'demangled.txt' | while read -r f; do cp "$f" artifacts/; done
          ls -l artifacts
      - name: Setup MSVC
        uses: ilammy/msvc-dev-cmd@v1
      
      - name: Install Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.x'
      
      - name: Download MFC symbol database
        uses: actions/download-artifact@v7
        with:
          name: phase1_exports
          path: phase1_artifacts
      
      - name: Build openmfc.dll (stubs + RTTI)
        run: |
          ./phase3/scripts/build_phase3.sh
      
      - name: Smoke test
        run: |
          DLL=build-phase3/openmfc.dll MIN_EXPORTS=100 ./scripts/openmfc_smoke_test.sh
      
      - name: Upload MinGW artifacts
        uses: actions/upload-artifact@v5
        with:
          name: phase3_mingw_artifacts
          path: |
            build-phase3/openmfc.dll
            build-phase3/openmfc.def
          retention-days: 7

  verify-on-windows:
    needs: build-mingw-dll
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v6
      
      - name: Download MinGW artifacts
        uses: actions/download-artifact@v4
        with:
          name: phase3_mingw_artifacts
          path: build-phase3

      - name: Setup MSVC
        uses: ilammy/msvc-dev-cmd@v1

      - name: Generate import library from actual .def file
        shell: pwsh
        run: |
          # Use the actual .def file from the MinGW build
          # It now has full MSVC-mangled names (fixed truncation issue)
          lib /DEF:build-phase3/openmfc.def /OUT:openmfc.lib /MACHINE:X64
          
          echo "Created import library from: build-phase3/openmfc.def"
          echo "DLL exports MSVC-mangled names, import library should match"
      
      - name: Build basic test application
        shell: cmd
        run: |
          cl /nologo /EHsc /MD tests/test_msvc_app.cpp openmfc.lib /Fe:test_app.exe

      - name: Build MFC smoke test (uses real afx.h headers)
        shell: cmd
        run: |
          cl /nologo /EHsc /MD /D_AFXDLL tests/test_mfc_smoke.cpp openmfc.lib /Fe:test_mfc_smoke.exe
          echo MFC smoke test linked successfully - all CString symbols resolved

      - name: Run MFC smoke test
        shell: pwsh
        run: |
          # Copy DLL to current directory for runtime linking
          Copy-Item build-phase3/openmfc.dll .
          
          Write-Host "Running MFC smoke test (compile-time linked)..."
          $output = & .\test_mfc_smoke.exe 2>&1 | Out-String
          Write-Host $output
          Write-Host ""
          Write-Host "Exit code: $LASTEXITCODE"
          if ($LASTEXITCODE -ne 0) {
            Write-Error "MFC smoke test failed"
            exit 1
          }

      - name: Run basic test application
        shell: pwsh
        run: |
          # Copy DLL to current directory for runtime linking
          Copy-Item build-phase3/openmfc.dll .

          $output = & .\test_app.exe 2>&1 | Out-String
          Write-Host $output

          # Check for success indicators:
          # 1. "All tests passed" - proves linking worked and stubs were called
          # 2. "Not Implemented" - proves we're actually calling OpenMFC stubs
          $hasAllTestsPassed = $output -match "All tests passed"
          $hasNotImplemented = $output -match "Not Implemented"

          if ($hasAllTestsPassed -and $hasNotImplemented) {
            Write-Host "SUCCESS: MSVC linking verified - test passed and stubs were called"
            exit 0
          } elseif ($hasAllTestsPassed) {
            Write-Host "SUCCESS: MSVC linking verified (stubs may not print to stderr)"
            exit 0
          } else {
            Write-Host "ERROR: Test did not pass - check output above"
            exit 1
          }
      
      - name: Upload artifacts
        uses: actions/upload-artifact@v6
        with:
          name: phase3_openmfc
          path: |
            openmfc.dll
            openmfc.lib
            openmfc.exp
            build-phase3/openmfc.def
          retention-days: 14