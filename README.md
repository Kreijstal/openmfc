# OpenMFC

OpenMFC is a clean-room, binary-compatible reimplementation of the
Microsoft Foundation Class (MFC) runtime (`mfc140u.dll`).

> **Note:** ATL became header-only starting with VS2015 (v140), so there is no
> `atl140.dll` to reimplement.

This repository is structured in phases. **Phase 0A** is about ABI discovery:
we build a tiny MSVC DLL in CI and dump its exports and symbols to learn how
MSVC lays out a simple C++ class.

See `docs/abi_reference.md` for ongoing notes.

## Key Files for ABI Compatibility

### Ordinal Mapping Files

- `mfc_complete_ordinal_mapping.json` - **Primary mapping file** with 14,109 symbol→ordinal mappings extracted from real MFC .lib file (`dumpbin /ALL mfc140u.lib`). Contains real ordinals (256-14370 range).
  - **Generated by**: `tools/create_complete_mapping.py` using `/tmp/real_ordinals_new.json` from `tools/extract_ordinals.py`
  - **Source**: `dumpbin /ALL mfc140u.lib` output (27MB text file from CI artifacts)
  
- `mfc_real_ordinal_mapping.json` - Subset of complete mapping (1,619 symbols) matched against our extracted symbol list.
  - **Generated by**: `tools/create_real_mapping.py` matching `artifacts/mfc_symbols.txt` with real ordinals
  
- `mfc_ordinal_mapping.json` - Legacy mapping with guessed ordinals (array index + 256). **Not ABI compatible**.
  - **Generated by**: Early symbol extraction scripts

### Build Configuration

- `scripts/build_openmfc_mingw.sh` - Build script that uses `mfc_complete_ordinal_mapping.json` when available.
  - **Priority**: Complete mapping → Real mapping → Guessed mapping → Legacy DB
  
- `msvc_openmfc.def` - MSVC .def file generated from complete mapping for creating import libraries.
  - **Generated by**: `tools/create_msvc_lib.py --mapping mfc_complete_ordinal_mapping.json`
  
- `tools/create_msvc_lib.py` - Generate MSVC .def file from ordinal mapping.

### Symbol Extraction Tools

- `tools/extract_all_symbols.py` - Extract all symbols from `dumpbin /SYMBOLS` output.
- `tools/create_complete_mapping.py` - Create complete ordinal mapping from dumpbin /ALL output.
- `tools/extract_ordinals.py` - Parse `dumpbin /ALL` output to extract symbol→ordinal mappings.
- `tools/extract_symbols_proper.py` - Legacy symbol extraction filtering char versions.

## Building with Real Ordinals

```bash
# Build with complete ordinal mapping (ABI compatible)
./scripts/build_openmfc_mingw.sh

# Or manually specify mapping
BUILD=./build MAPPING=./mfc_complete_ordinal_mapping.json ./scripts/build_openmfc_mingw.sh
```

The build script automatically uses `mfc_complete_ordinal_mapping.json` if present, falling back to other mappings.

## Regenerating Mappings

### From CI Artifacts
1. Run Phase 1 workflow to get `mfc_lib_all.txt` (dumpbin /ALL output)
2. Extract ordinals: `python tools/extract_ordinals.py --dumpbin /path/to/mfc_lib_all.txt --out /tmp/real_ordinals_new.json`
3. Create complete mapping: `python tools/create_complete_mapping.py`

### From Existing Data
```bash
# Extract ordinals from existing dumpbin output
python tools/extract_ordinals.py --dumpbin artifacts/mfc_lib_all.txt --out real_ordinals.json

# Create complete mapping
python tools/create_complete_mapping.py

# Create MSVC .def file
python tools/create_msvc_lib.py --mapping mfc_complete_ordinal_mapping.json --out-def msvc_openmfc.def
```

## Testing ABI Compatibility

- `tests/test_direct.cpp` - Test loading functions by ordinal (2350 for AfxThrowMemoryException).
- `tests/test_msvc_app.cpp` - MSVC test app for linking with import library.
- CI workflows in `.github/workflows/` test cross-platform compatibility.

## MSVC Mangling Requirement

OpenMFC DLL exports use **MSVC name mangling** (e.g., `?AfxThrowMemoryException@@YAXXZ`) for ABI compatibility with real MFC. This causes linking issues with MinGW which expects GCC mangling (`_Z23AfxThrowMemoryExceptionv`).

### Why MSVC Mangling is Required

1. **Real MFC DLL exports MSVC-mangled names** - Must match exactly for ABI compatibility
2. **MSVC import libraries (.lib) expect MSVC mangling** - Linking fails with GCC mangling
3. **Ordinal-based exports require exact symbol names** - `GetProcAddress` by name needs MSVC mangling

### Verification of MSVC Mangling

The verification scripts specifically check for MSVC-mangled symbols:

```bash
# Check if DLL has MSVC-mangled exports
./scripts/verify_abi_compatibility.sh build/openmfc.dll mfc_db.json

# Expected to find in DLL exports:
#   ?AfxThrowMemoryException@@YAXXZ @2350
#   ?AfxThrowFileException@@YAXXZ @2351
#   ... (14,109 MSVC-mangled symbols)

# Will FAIL if finds GCC-mangled names:
#   _Z23AfxThrowMemoryExceptionv @2350  ❌
#   AfxThrowMemoryException @2350       ❌
```

### Workarounds:

1. **Load by ordinal** (recommended for testing):
   ```cpp
   // Get function by ordinal 2350
   auto func = (AfxThrowMemoryExceptionFunc)GetProcAddress(
       hModule, MAKEINTRESOURCEA(2350));
   ```

2. **Use MSVC compiler** for linking (real MFC apps):
   ```bash
   # On Windows with MSVC
   lib /DEF:msvc_openmfc.def /OUT:openmfc.lib
   cl test_msvc_app.cpp openmfc.lib
   ```

3. **Create MinGW import library with aliases** (not implemented):
   Would need GCC→MSVC mangling translation in import library.

### Verification Scripts

**`scripts/verify_abi_compatibility.sh`** - Main verification wrapper:
```bash
# Verify DLL exports match MFC database
./scripts/verify_abi_compatibility.sh build/openmfc.dll mfc_db.json
```

**`scripts/verify_dll_exports.ps1`** - Windows PowerShell script (requires `dumpbin`):
```powershell
# On Windows with MSVC installed
powershell -ExecutionPolicy Bypass -File scripts/verify_dll_exports.ps1 -DllPath openmfc.dll -MfcDbPath mfc_db.json
```

**`scripts/verify_ordinal_exports.sh`** - Linux/macOS approximate verification:
```bash
# Checks .def file instead of actual DLL
./scripts/verify_ordinal_exports.sh build/openmfc.dll mfc_db.json
```

**What they check**:
1. **MSVC mangled symbols** - Exports must use MSVC mangling (e.g., `?AfxThrowMemoryException@@YAXXZ`)
2. **Correct ordinals** - Symbols must be at correct ordinals (e.g., 2350 for AfxThrowMemoryException)
3. **Complete export set** - All expected symbols from MFC database must be present

**Fails if**:
- DLL exports GCC-mangled names instead of MSVC-mangled names
- Symbols are at wrong ordinals
- Missing expected exports
- Using guessed ordinals instead of real ordinals

**Example failure**:
```
MISSING: ?AfxThrowMemoryException@@YAXXZ (ordinal 2350)
WRONG ORDINAL: ?AfxThrowFileException@@YAXXZ (expected 2351, got 256)
❌ Export verification failed
```

## Phase Structure

- **Phase 0A**: ABI discovery and reference implementation
- **Phase 1**: MFC symbol extraction and ordinal mapping
- **Phase 3**: Cross-platform validation (MinGW→MSVC linking)

See individual phase directories for detailed documentation.
